# KubeFoundry ä¸€é”®éƒ¨ç½²è„šæœ¬æ¶æ„è®¾è®¡

## ğŸ“‹ å…¬ç”¨æ–¹æ³•ç´¢å¼•

æœ¬æ–‡æ¡£å®šä¹‰äº† K8S è‡ªåŠ¨åŒ–éƒ¨ç½²è¿‡ç¨‹ä¸­éœ€è¦çš„æ‰€æœ‰å…¬ç”¨æ–¹æ³•ã€‚ä»¥ä¸‹æ˜¯æ–¹æ³•åˆ†ç±»ç´¢å¼•ï¼š

### ğŸ”§ é…ç½®ç®¡ç†æ–¹æ³• (core/config_parser.sh)
| æ–¹æ³•å | åŠŸèƒ½æè¿° |
|--------|---------|
| `config_load()` | åŠ è½½å¹¶è§£æ YAML é…ç½®æ–‡ä»¶ |
| `config_get()` | è·å–æŒ‡å®šè·¯å¾„çš„é…ç½®å€¼ |
| `config_get_node()` | è·å–æŒ‡å®šèŠ‚ç‚¹çš„é…ç½®ä¿¡æ¯ |
| `config_get_control_nodes()` | è·å–æ‰€æœ‰æ§åˆ¶èŠ‚ç‚¹ä¸»æœºååˆ—è¡¨ |
| `config_get_worker_nodes()` | è·å–æ‰€æœ‰å·¥ä½œèŠ‚ç‚¹ä¸»æœºååˆ—è¡¨ |
| `config_get_all_nodes()` | è·å–æ‰€æœ‰èŠ‚ç‚¹ä¸»æœºååˆ—è¡¨ |
| `config_validate()` | éªŒè¯é…ç½®æ–‡ä»¶çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ |

### ğŸŒ SSH è¿œç¨‹æ‰§è¡Œæ–¹æ³• (utils/ssh.sh)
| æ–¹æ³•å | åŠŸèƒ½æè¿° |
|--------|---------|
| `ssh_check_connection()` | æ£€æŸ¥ SSH è¿æ¥æ˜¯å¦å¯ç”¨ |
| `ssh_execute()` | åœ¨è¿œç¨‹èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤ï¼ˆåŒæ­¥ï¼‰ |
| `ssh_execute_script()` | åœ¨è¿œç¨‹èŠ‚ç‚¹æ‰§è¡Œæœ¬åœ°è„šæœ¬æ–‡ä»¶ |
| `ssh_execute_async()` | åœ¨è¿œç¨‹èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤ï¼ˆå¼‚æ­¥ï¼‰ |
| `ssh_execute_parallel()` | å¹¶è¡Œåœ¨å¤šä¸ªèŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤ |
| `ssh_copy_file()` | å¤åˆ¶æ–‡ä»¶åˆ°è¿œç¨‹èŠ‚ç‚¹ |
| `ssh_copy_directory()` | å¤åˆ¶æ–‡ä»¶å¤¹åˆ°è¿œç¨‹èŠ‚ç‚¹ |
| `ssh_copy_file_from()` | ä»è¿œç¨‹èŠ‚ç‚¹å¤åˆ¶æ–‡ä»¶ |
| `ssh_interactive()` | å»ºç«‹äº¤äº’å¼ SSH ä¼šè¯ |

### ğŸ“ æ—¥å¿—ç®¡ç†æ–¹æ³• (utils/logger.sh)
| æ–¹æ³•å | åŠŸèƒ½æè¿° |
|--------|---------|
| `log_init()` | åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ |
| `log_debug()` | è®°å½•è°ƒè¯•çº§åˆ«æ—¥å¿— |
| `log_info()` | è®°å½•ä¿¡æ¯çº§åˆ«æ—¥å¿— |
| `log_warn()` | è®°å½•è­¦å‘Šçº§åˆ«æ—¥å¿— |
| `log_error()` | è®°å½•é”™è¯¯çº§åˆ«æ—¥å¿— |
| `log_critical()` | è®°å½•ä¸¥é‡é”™è¯¯æ—¥å¿— |
| `log_success()` | è®°å½•æˆåŠŸä¿¡æ¯ï¼ˆå¿«æ·æ–¹æ³•ï¼‰ |
| `log_failure()` | è®°å½•å¤±è´¥ä¿¡æ¯ï¼ˆå¿«æ·æ–¹æ³•ï¼‰ |
| `log_node_info()` | è®°å½•èŠ‚ç‚¹ç›¸å…³ä¿¡æ¯ |

### âœ… éªŒè¯æ£€æŸ¥æ–¹æ³• (utils/validator.sh)
| æ–¹æ³•å | åŠŸèƒ½æè¿° |
|--------|---------|
| `validate_config()` | éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼å’Œå¿…éœ€å‚æ•° |
| `validate_ip()` | éªŒè¯ IP åœ°å€æ ¼å¼ |
| `validate_hostname()` | éªŒè¯ä¸»æœºåæ ¼å¼ |
| `validate_port()` | éªŒè¯ç«¯å£å·æœ‰æ•ˆæ€§ |
| `validate_os()` | éªŒè¯æ“ä½œç³»ç»Ÿå…¼å®¹æ€§ |
| `validate_memory()` | éªŒè¯å†…å­˜èµ„æºæ˜¯å¦æ»¡è¶³è¦æ±‚ |
| `validate_disk()` | éªŒè¯ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³ |
| `validate_network()` | éªŒè¯ç½‘ç»œè¿é€šæ€§ |
| `validate_command()` | éªŒè¯å‘½ä»¤æ˜¯å¦å­˜åœ¨ |
| `validate_service()` | éªŒè¯æœåŠ¡çŠ¶æ€ |

### ğŸ”„ é‡è¯•æœºåˆ¶æ–¹æ³• (utils/retry.sh)
| æ–¹æ³•å | åŠŸèƒ½æè¿° |
|--------|---------|
| `retry_execute()` | é‡è¯•æ‰§è¡Œå‘½ä»¤ç›´åˆ°æˆåŠŸæˆ–è¾¾åˆ°æœ€å¤§æ¬¡æ•° |
| `retry_function()` | é‡è¯•æ‰§è¡Œå‡½æ•° |
| `wait_for_condition()` | ç­‰å¾…æ¡ä»¶æ»¡è¶³ |
| `wait_for_port()` | ç­‰å¾…ç«¯å£å¯ç”¨ |
| `wait_for_service_ready()` | ç­‰å¾…æœåŠ¡å°±ç»ª |
| `wait_for_pod_ready()` | ç­‰å¾… Pod å°±ç»ª |

### ğŸ¯ æ¨¡å—ç®¡ç†æ–¹æ³• (core/module_manager.sh)
| æ–¹æ³•å | åŠŸèƒ½æè¿° |
|--------|---------|
| `module_load()` | åŠ è½½æŒ‡å®šæ¨¡å— |
| `module_execute()` | æ‰§è¡Œæ¨¡å—ï¼ˆå®Œæ•´æµç¨‹ï¼šcheckâ†’installâ†’verifyï¼‰ |
| `module_pre_check()` | æ‰§è¡Œæ¨¡å—å‰ç½®æ£€æŸ¥ |
| `module_install()` | æ‰§è¡Œæ¨¡å—å®‰è£… |
| `module_post_check()` | æ‰§è¡Œæ¨¡å—åç½®éªŒè¯ |
| `module_rollback()` | æ‰§è¡Œæ¨¡å—å›æ»š |
| `module_info()` | è·å–æ¨¡å—ä¿¡æ¯ |
| `module_list()` | åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ¨¡å— |

### ğŸ“Š çŠ¶æ€ç®¡ç†æ–¹æ³• (core/state_manager.sh)
| æ–¹æ³•å | åŠŸèƒ½æè¿° |
|--------|---------|
| `state_create()` | åˆ›å»ºéƒ¨ç½²çŠ¶æ€æ–‡ä»¶ |
| `state_load()` | åŠ è½½éƒ¨ç½²çŠ¶æ€ |
| `state_save()` | ä¿å­˜éƒ¨ç½²çŠ¶æ€ |
| `state_update()` | æ›´æ–°çŠ¶æ€å€¼ |
| `state_get()` | è·å–çŠ¶æ€å€¼ |
| `state_is_completed()` | æ£€æŸ¥é˜¶æ®µæ˜¯å¦å·²å®Œæˆ |
| `state_get_current_stage()` | è·å–å½“å‰æ‰§è¡Œé˜¶æ®µ |
| `state_set_stage_completed()` | æ ‡è®°é˜¶æ®µä¸ºå·²å®Œæˆ |
| `state_reset()` | é‡ç½®éƒ¨ç½²çŠ¶æ€ |

### ğŸ› ï¸ é€šç”¨å·¥å…·æ–¹æ³• (utils/common.sh)
| æ–¹æ³•å | åŠŸèƒ½æè¿° |
|--------|---------|
| `trim()` | å»é™¤å­—ç¬¦ä¸²é¦–å°¾ç©ºæ ¼ |
| `to_lower()` | è½¬æ¢ä¸ºå°å†™ |
| `to_upper()` | è½¬æ¢ä¸ºå¤§å†™ |
| `file_exists()` | æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ |
| `dir_exists()` | æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨ |
| `create_dir()` | åˆ›å»ºç›®å½• |
| `remove_file()` | åˆ é™¤æ–‡ä»¶ |
| `confirm()` | ç”¨æˆ·ç¡®è®¤æç¤º |
| `select_option()` | ç”¨æˆ·é€‰æ‹©æç¤º |
| `get_timestamp()` | è·å–å½“å‰æ—¶é—´æˆ³ |
| `format_datetime()` | æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ |

---

## 1. æ•´ä½“æ¶æ„è¿è½¬æœºåˆ¶

### 1.1 æ ¸å¿ƒæ€æƒ³

**æ ¸å¿ƒæœºåˆ¶**ï¼šdeploy.sh ä½œä¸ºä¸­å¤®æ§åˆ¶å™¨ï¼Œåœ¨æœ¬åœ°ï¼ˆç®¡ç†èŠ‚ç‚¹ï¼‰è¿è¡Œï¼Œé€šè¿‡ SSH è¿œç¨‹æ‰§è¡Œå‘½ä»¤åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œå®ç°åˆ†å¸ƒå¼éƒ¨ç½²ã€‚

**æ¶æ„å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç®¡ç†èŠ‚ç‚¹ (Management Node)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         deploy.sh (ä¸»æ§åˆ¶è„šæœ¬)                   â”‚  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â”‚  æ‰§è¡Œæµç¨‹:                                        â”‚  â”‚
â”‚  â”‚  1. config_load() - åŠ è½½é…ç½®æ–‡ä»¶                 â”‚  â”‚
â”‚  â”‚  2. config_get_all_nodes() - è·å–èŠ‚ç‚¹åˆ—è¡¨        â”‚  â”‚
â”‚  â”‚  3. å¾ªç¯æ¯ä¸ªèŠ‚ç‚¹:                                 â”‚  â”‚
â”‚  â”‚     a. config_get_node(node, "ip") - è·å–IP     â”‚  â”‚
â”‚  â”‚     b. ssh_execute(ip, command) - è¿œç¨‹æ‰§è¡Œ      â”‚  â”‚
â”‚  â”‚     c. æ£€æŸ¥è¿”å›å€¼å¹¶è®°å½•æ—¥å¿—                       â”‚  â”‚
â”‚  â”‚  4. ç»§ç»­ä¸‹ä¸€æ­¥æˆ–å›æ»š                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                      â”‚                                   â”‚
â”‚                      â”‚ SSH è¿æ¥                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      â”‚                                   â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚         â”‚                         â”‚                      â”‚
â”‚         â–¼                         â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  k8sc1     â”‚            â”‚  k8sw1     â”‚               â”‚
â”‚  â”‚ (æ§åˆ¶èŠ‚ç‚¹)  â”‚            â”‚ (å·¥ä½œèŠ‚ç‚¹)  â”‚               â”‚
â”‚  â”‚            â”‚            â”‚            â”‚               â”‚
â”‚  â”‚ æ¥æ”¶ SSH   â”‚            â”‚ æ¥æ”¶ SSH   â”‚               â”‚
â”‚  â”‚ æ‰§è¡Œå‘½ä»¤   â”‚            â”‚ æ‰§è¡Œå‘½ä»¤   â”‚               â”‚
â”‚  â”‚ è¿”å›ç»“æœ   â”‚            â”‚ è¿”å›ç»“æœ   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ•°æ®æµè½¬æœºåˆ¶

**é…ç½®æ•°æ®æµè½¬**ï¼š
```
config.yaml
    â†“
config_load() - åŠ è½½é…ç½®æ–‡ä»¶
    â†“
CONFIG_CACHE - å†…å­˜ç¼“å­˜
    â†“
config_get(path) - è·å–é…ç½®å€¼
    â†“
è¿”å›é…ç½®æ•°æ®
```

**æ‰§è¡Œå‘½ä»¤æµè½¬**ï¼š
```
deploy.sh ä¸»è„šæœ¬
    â†“
module_execute(module_name) - æ‰§è¡Œæ¨¡å—
    â†“
module_install() - æ¨¡å—å®‰è£…é€»è¾‘
    â†“
for node in $(config_get_all_nodes()) - å¾ªç¯èŠ‚ç‚¹
    â†“
node_ip=$(config_get_node($node, "ip")) - è·å–èŠ‚ç‚¹IP
    â†“
ssh_execute($node_ip, $command) - è¿œç¨‹æ‰§è¡Œ
    â†“
æ£€æŸ¥è¿”å›å€¼
    â†“
log_info() - è®°å½•æ—¥å¿—
    â†“
ç»§ç»­æˆ–é€€å‡º
```

---

## 2. é…ç½®ç®¡ç†æ–¹æ³•

**æ–‡ä»¶ä½ç½®**: `core/config_parser.sh`

### 2.1 config_load()

åŠ è½½å¹¶è§£æ YAML é…ç½®æ–‡ä»¶ã€‚

**å…¥å‚**:
- `$1` (string): é…ç½®æ–‡ä»¶è·¯å¾„

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥
- å…¨å±€å˜é‡: `CONFIG_FILE` (é…ç½®æ–‡ä»¶è·¯å¾„)

**å¼‚å¸¸å¤„ç†**:
- é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ â†’ è®°å½•é”™è¯¯æ—¥å¿—å¹¶é€€å‡º
- YAML è¯­æ³•é”™è¯¯ â†’ è®°å½•é”™è¯¯æ—¥å¿—å¹¶é€€å‡º

**ç¤ºä¾‹**:
```bash
config_load "config/config.yaml"
```

### 2.2 config_get()

è·å–æŒ‡å®šè·¯å¾„çš„é…ç½®å€¼ã€‚

**å…¥å‚**:
- `$1` (string): YAML è·¯å¾„è¡¨è¾¾å¼ï¼ˆå¦‚ï¼š`.k8s.version`ï¼‰
- `$2` (string, å¯é€‰): é»˜è®¤å€¼

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: é…ç½®å€¼ï¼ˆå­—ç¬¦ä¸²ï¼‰
- è¿”å›å€¼: `0` æˆåŠŸ

**ç¼“å­˜æœºåˆ¶**:
- ä½¿ç”¨ `CONFIG_CACHE` å…³è”æ•°ç»„ç¼“å­˜å·²è§£æçš„å€¼

**ç¤ºä¾‹**:
```bash
k8s_version=$(config_get ".k8s.version")
pod_subnet=$(config_get ".network.cluster.pod_subnet" "10.244.0.0/16")
```

### 2.3 config_get_node()

è·å–æŒ‡å®šèŠ‚ç‚¹çš„é…ç½®ä¿¡æ¯ã€‚

**å…¥å‚**:
- `$1` (string): èŠ‚ç‚¹ä¸»æœºåï¼ˆå¦‚ï¼š`k8sc1`ï¼‰
- `$2` (string): å­—æ®µåï¼ˆ`ip`, `ipv6`, `role`ï¼‰

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: èŠ‚ç‚¹é…ç½®å€¼
- è¿”å›å€¼: `0` æˆåŠŸ

**æŸ¥æ‰¾é¡ºåº**:
1. æ§åˆ¶èŠ‚ç‚¹åˆ—è¡¨
2. å·¥ä½œèŠ‚ç‚¹åˆ—è¡¨
3. é•œåƒä»“åº“èŠ‚ç‚¹

**ç¤ºä¾‹**:
```bash
node_ip=$(config_get_node "k8sc1" "ip")
node_role=$(config_get_node "k8sc1" "role")
```

### 2.4 config_get_control_nodes()

è·å–æ‰€æœ‰æ§åˆ¶èŠ‚ç‚¹ä¸»æœºååˆ—è¡¨ã€‚

**å…¥å‚**: æ— 

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: æ§åˆ¶èŠ‚ç‚¹ä¸»æœºååˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰

**ç¤ºä¾‹**:
```bash
control_nodes=$(config_get_control_nodes)
# è¾“å‡ºç¤ºä¾‹:
# k8sc1
# k8sc2
# k8sc3
```

### 2.5 config_get_worker_nodes()

è·å–æ‰€æœ‰å·¥ä½œèŠ‚ç‚¹ä¸»æœºååˆ—è¡¨ã€‚

**å…¥å‚**: æ— 

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: å·¥ä½œèŠ‚ç‚¹ä¸»æœºååˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰

**ç¤ºä¾‹**:
```bash
worker_nodes=$(config_get_worker_nodes)
```

### 2.6 config_get_all_nodes()

è·å–æ‰€æœ‰èŠ‚ç‚¹ä¸»æœºååˆ—è¡¨ã€‚

**å…¥å‚**: æ— 

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: æ‰€æœ‰èŠ‚ç‚¹ä¸»æœºååˆ—è¡¨ï¼ˆæ’åºã€å»é‡ï¼‰

**ç¤ºä¾‹**:
```bash
all_nodes=$(config_get_all_nodes)
```

### 2.7 config_validate()

éªŒè¯é…ç½®æ–‡ä»¶çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ã€‚

**å…¥å‚**: æ— ï¼ˆä½¿ç”¨å…¨å±€ `CONFIG_FILE`ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` éªŒè¯é€šè¿‡, `1` éªŒè¯å¤±è´¥

**éªŒè¯é¡¹**:
- å¿…éœ€å‚æ•°æ˜¯å¦å­˜åœ¨
- IP åœ°å€æ ¼å¼æ˜¯å¦æ­£ç¡®
- ç«¯å£å·æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´
- æ–‡ä»¶è·¯å¾„æ˜¯å¦å¯è®¿é—®

**ç¤ºä¾‹**:
```bash
if ! config_validate; then
    log_error "é…ç½®éªŒè¯å¤±è´¥"
    exit 1
fi
```

---

## 3. SSH è¿œç¨‹æ‰§è¡Œæ–¹æ³•

**æ–‡ä»¶ä½ç½®**: `utils/ssh.sh`

### 3.1 ssh_check_connection()

æ£€æŸ¥ SSH è¿æ¥æ˜¯å¦å¯ç”¨ã€‚

**å…¥å‚**:
- `$1` (string): ç›®æ ‡èŠ‚ç‚¹ IP åœ°å€

**å‡ºå‚**:
- è¿”å›å€¼: `0` è¿æ¥æˆåŠŸ, `1` è¿æ¥å¤±è´¥

**é‡è¯•æœºåˆ¶**:
- æœ€å¤šé‡è¯• 3 æ¬¡
- æ¯æ¬¡é—´éš” 2 ç§’

**ç¤ºä¾‹**:
```bash
if ssh_check_connection "10.3.66.18"; then
    log_info "èŠ‚ç‚¹è¿æ¥æ­£å¸¸"
else
    log_error "èŠ‚ç‚¹æ— æ³•è¿æ¥"
fi
```

### 3.2 ssh_execute()

åœ¨è¿œç¨‹èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤ï¼ˆåŒæ­¥ï¼‰ã€‚

**å…¥å‚**:
- `$1` (string): ç›®æ ‡èŠ‚ç‚¹ IP åœ°å€
- `$2` (string): è¦æ‰§è¡Œçš„å‘½ä»¤
- `$3` (int, å¯é€‰): è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤ 300ï¼‰

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: å‘½ä»¤æ‰§è¡Œç»“æœ
- è¿”å›å€¼: `0` æˆåŠŸ, é `0` å¤±è´¥ï¼ˆè¿”å›è¿œç¨‹å‘½ä»¤çš„é€€å‡ºç ï¼‰

**ç‰¹æ€§**:
- åŒæ­¥æ‰§è¡Œï¼Œç­‰å¾…å‘½ä»¤å®Œæˆ
- æ”¯æŒè¶…æ—¶æ§åˆ¶
- è‡ªåŠ¨è®°å½•è°ƒè¯•æ—¥å¿—

**ç¤ºä¾‹**:
```bash
# æ‰§è¡Œç®€å•å‘½ä»¤
ssh_execute "10.3.66.18" "yum install -y containerd"

# æ‰§è¡Œå¤šè¡Œå‘½ä»¤
ssh_execute "10.3.66.18" "
    cd /tmp
    mkdir -p test
    echo 'done'
"

# å¸¦è¶…æ—¶æ§åˆ¶
ssh_execute "10.3.66.18" "long-running-command" 600
```

### 3.3 ssh_execute_script()

åœ¨è¿œç¨‹èŠ‚ç‚¹æ‰§è¡Œæœ¬åœ°è„šæœ¬æ–‡ä»¶ã€‚

**å…¥å‚**:
- `$1` (string): ç›®æ ‡èŠ‚ç‚¹ IP åœ°å€
- `$2` (string): æœ¬åœ°è„šæœ¬æ–‡ä»¶è·¯å¾„
- `$3` (string, å¯é€‰): è„šæœ¬å‚æ•°ï¼ˆå¯é€‰ï¼‰
- `$4` (int, å¯é€‰): è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤ 300ï¼‰

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: è„šæœ¬æ‰§è¡Œç»“æœ
- è¿”å›å€¼: `0` æˆåŠŸ, é `0` å¤±è´¥ï¼ˆè¿”å›è¿œç¨‹å‘½ä»¤çš„é€€å‡ºç ï¼‰

**ç‰¹æ€§**:
- è‡ªåŠ¨è¯»å–æœ¬åœ°è„šæœ¬å†…å®¹
- é€šè¿‡ SSH ä¼ é€’åˆ°è¿œç¨‹èŠ‚ç‚¹æ‰§è¡Œ
- æ”¯æŒå¸¦å‚æ•°çš„è„šæœ¬
- æ”¯æŒè¶…æ—¶æ§åˆ¶
- è‡ªåŠ¨è®°å½•è°ƒè¯•æ—¥å¿—
- è‡ªåŠ¨åœ¨è¿œç¨‹èŠ‚ç‚¹æ‰§è¡Œåæ¸…ç†

**å®ç°åŸç†**:
1. æ£€æŸ¥æœ¬åœ°è„šæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
2. è¯»å–è„šæœ¬å†…å®¹
3. é€šè¿‡ SSH ä¼ é€’è„šæœ¬å†…å®¹åˆ°è¿œç¨‹èŠ‚ç‚¹
4. åœ¨è¿œç¨‹èŠ‚ç‚¹ä¸Šé€šè¿‡ stdin æ‰§è¡Œè„šæœ¬

**ç¤ºä¾‹**:
```bash
# æ‰§è¡Œæœ¬åœ°è„šæœ¬åˆ°è¿œç¨‹èŠ‚ç‚¹ï¼ˆæ— å‚æ•°ï¼‰
ssh_execute_script "10.3.66.18" "/local/path/to/script.sh"

# æ‰§è¡Œæœ¬åœ°è„šæœ¬åˆ°è¿œç¨‹èŠ‚ç‚¹ï¼ˆå¸¦å‚æ•°ï¼‰
ssh_execute_script "10.3.66.18" "/local/path/to/script.sh" "arg1 arg2"

# å¸¦è¶…æ—¶æ§åˆ¶
ssh_execute_script "10.3.66.18" "/local/path/to/script.sh" "" 600

# å®é™…ä½¿ç”¨ç¤ºä¾‹
node_ip=$(config_get_node "k8sw1" "ip")
ssh_execute_script "$node_ip" "/data/scripts/install_containerd.sh"
```

**ä½¿ç”¨åœºæ™¯**:
- æ‰§è¡Œæœ¬åœ°çš„éƒ¨ç½²è„šæœ¬åˆ°è¿œç¨‹èŠ‚ç‚¹
- æ‰¹é‡æ‰§è¡Œé…ç½®è„šæœ¬
- éœ€è¦ä¿æŒè„šæœ¬åœ¨æœ¬åœ°ç»Ÿä¸€ç®¡ç†çš„åœºæ™¯

**å¯¹æ¯” ssh_execute()**:
- `ssh_execute()`: æ‰§è¡Œè¿œç¨‹èŠ‚ç‚¹ä¸Šçš„å‘½ä»¤æˆ–è„šæœ¬
- `ssh_execute_script()`: æ‰§è¡Œæœ¬åœ°è„šæœ¬æ–‡ä»¶åˆ°è¿œç¨‹èŠ‚ç‚¹ï¼ˆæ— éœ€å…ˆå¤åˆ¶ï¼‰

### 3.4 ssh_execute_async()

åœ¨è¿œç¨‹èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤ï¼ˆå¼‚æ­¥ï¼Œåå°è¿è¡Œï¼‰ã€‚

**å…¥å‚**:
- `$1` (string): ç›®æ ‡èŠ‚ç‚¹ IP åœ°å€
- `$2` (string): è¦æ‰§è¡Œçš„å‘½ä»¤
- `$3` (string): æ—¥å¿—æ–‡ä»¶è·¯å¾„

**å‡ºå‚**:
- è¿”å›å€¼: `0` å‘½ä»¤å·²æäº¤, `1` æäº¤å¤±è´¥

**ç‰¹æ€§**:
- ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…å‘½ä»¤å®Œæˆ
- ä½¿ç”¨ nohup ç¡®ä¿å‘½ä»¤æŒä¹…è¿è¡Œ
- è¾“å‡ºé‡å®šå‘åˆ°æŒ‡å®šæ—¥å¿—æ–‡ä»¶

**ç¤ºä¾‹**:
```bash
ssh_execute_async "10.3.66.18" "sleep 100" "/tmp/sleep.log"
```

### 3.5 ssh_execute_parallel()

å¹¶è¡Œåœ¨å¤šä¸ªèŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤ã€‚

**å…¥å‚**:
- `$1` (string): èŠ‚ç‚¹åˆ—è¡¨ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰
- `$2` (string): è¦æ‰§è¡Œçš„å‘½ä»¤
- `$3` (int, å¯é€‰): æœ€å¤§å¹¶å‘æ•°ï¼ˆé»˜è®¤ 5ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸ, `1` è‡³å°‘ä¸€ä¸ªèŠ‚ç‚¹å¤±è´¥

**å¹¶å‘æ§åˆ¶**:
- åŒæ—¶æœ€å¤š N ä¸ªèŠ‚ç‚¹åœ¨æ‰§è¡Œ
- ç­‰å¾…ä¸€æ‰¹å®Œæˆåå†æ‰§è¡Œä¸‹ä¸€æ‰¹

**ç¤ºä¾‹**:
```bash
# åœ¨æ‰€æœ‰å·¥ä½œèŠ‚ç‚¹å¹¶è¡Œæ‰§è¡Œ
worker_nodes="k8sw1 k8sw2 k8sw3"
ssh_execute_parallel "$worker_nodes" "systemctl restart kubelet"

# æ§åˆ¶å¹¶å‘æ•°ä¸º 3
ssh_execute_parallel "$worker_nodes" "yum update -y" 3
```

### 3.6 ssh_copy_file()

å¤åˆ¶æ–‡ä»¶åˆ°è¿œç¨‹èŠ‚ç‚¹ã€‚

**å…¥å‚**:
- `$1` (string): æœ¬åœ°æ–‡ä»¶è·¯å¾„
- `$2` (string): ç›®æ ‡èŠ‚ç‚¹ IP åœ°å€
- `$3` (string): è¿œç¨‹æ–‡ä»¶è·¯å¾„

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥

**ç¤ºä¾‹**:
```bash
ssh_copy_file "/tmp/config.yaml" "10.3.66.18" "/etc/kubernetes/"
```

### 3.7 ssh_copy_directory()

å¤åˆ¶æ–‡ä»¶å¤¹åˆ°è¿œç¨‹èŠ‚ç‚¹ã€‚

**å…¥å‚**:
- `$1` (string): æœ¬åœ°ç›®å½•è·¯å¾„
- `$2` (string): ç›®æ ‡èŠ‚ç‚¹ IP åœ°å€
- `$3` (string): è¿œç¨‹ç›®å½•è·¯å¾„
- `$4` (string, å¯é€‰): æ’é™¤æ¨¡å¼ï¼ˆrsync --exclude å‚æ•°ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥

**ç‰¹æ€§**:
- ä½¿ç”¨ rsync åè®®ä¼ è¾“ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ 
- è‡ªåŠ¨ä¿æŒç›®å½•ç»“æ„ã€æƒé™ã€æ—¶é—´æˆ³
- æ”¯æŒæ’é™¤ç‰¹å®šæ–‡ä»¶æˆ–ç›®å½•
- æ˜¾ç¤ºä¼ è¾“è¿›åº¦
- è‡ªåŠ¨åˆ›å»ºè¿œç¨‹ç›®å½•

**ç¤ºä¾‹**:
```bash
# å¤åˆ¶æ•´ä¸ªç›®å½•
ssh_copy_directory "/data/k8s_install" "10.3.66.18" "/data/k8s_install"

# æ’é™¤æ—¥å¿—æ–‡ä»¶
ssh_copy_directory "/data/app" "10.3.66.18" "/data/app" "*.log"

# æ’é™¤å¤šä¸ªæ–‡ä»¶ç±»å‹
ssh_copy_directory "/data/scripts" "10.3.66.18" "/data/scripts" "*.tmp --exclude=*.bak"
```

### 3.8 ssh_copy_file_from()

ä»è¿œç¨‹èŠ‚ç‚¹å¤åˆ¶æ–‡ä»¶ã€‚

**å…¥å‚**:
- `$1` (string): æºèŠ‚ç‚¹ IP åœ°å€
- `$2` (string): è¿œç¨‹æ–‡ä»¶è·¯å¾„
- `$3` (string): æœ¬åœ°æ–‡ä»¶è·¯å¾„

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥

**ç¤ºä¾‹**:
```bash
ssh_copy_file_from "10.3.66.18" "/var/log/kubelet.log" "/tmp/kubelet.log"
```

### 3.9 ssh_interactive()

å»ºç«‹äº¤äº’å¼ SSH ä¼šè¯ã€‚

**å…¥å‚**:
- `$1` (string): ç›®æ ‡èŠ‚ç‚¹ IP åœ°å€

**å‡ºå‚**:
- è¿”å›å€¼: æ— ï¼ˆè¿›å…¥äº¤äº’æ¨¡å¼ï¼‰

**ç¤ºä¾‹**:
```bash
ssh_interactive "10.3.66.18"
```

---

## 4. æ—¥å¿—ç®¡ç†æ–¹æ³•

**æ–‡ä»¶ä½ç½®**: `utils/logger.sh`

### 4.1 log_init()

åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿã€‚

**å…¥å‚**:
- `$1` (string): æ—¥å¿—æ–‡ä»¶è·¯å¾„
- `$2` (string, å¯é€‰): æ—¥å¿—çº§åˆ«ï¼ˆ`DEBUG`/`INFO`/`WARN`/`ERROR`ï¼Œé»˜è®¤ `INFO`ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ
- å…¨å±€å˜é‡: `LOG_FILE`, `LOG_LEVEL`

**åˆå§‹åŒ–æ“ä½œ**:
- åˆ›å»ºæ—¥å¿—ç›®å½•
- æ¸…ç©ºæ—§æ—¥å¿—æ–‡ä»¶
- è®°å½•å¯åŠ¨ä¿¡æ¯

**ç¤ºä¾‹**:
```bash
log_init "logs/deploy.log" "INFO"
```

### 4.2 log_debug()

è®°å½•è°ƒè¯•çº§åˆ«æ—¥å¿—ã€‚

**å…¥å‚**:
- `$1` (string): æ—¥å¿—æ¶ˆæ¯
- `$2` (string, å¯é€‰): èŠ‚ç‚¹åç§°

**å‡ºå‚**: æ— 

**è¾“å‡ºæ¡ä»¶**: ä»…å½“ `LOG_LEVEL` ä¸º `DEBUG` æ—¶è¾“å‡º

**ç¤ºä¾‹**:
```bash
log_debug "å¼€å§‹å®‰è£…ç»„ä»¶" "k8sc1"
```

### 4.3 log_info()

è®°å½•ä¿¡æ¯çº§åˆ«æ—¥å¿—ã€‚

**å…¥å‚**:
- `$1` (string): æ—¥å¿—æ¶ˆæ¯
- `$2` (string, å¯é€‰): èŠ‚ç‚¹åç§°

**å‡ºå‚**: æ— 

**è¾“å‡ºæ¡ä»¶**: `DEBUG`, `INFO`, `WARN`, `ERROR` çº§åˆ«éƒ½ä¼šè¾“å‡º

**ç¤ºä¾‹**:
```bash
log_info "å¼€å§‹éƒ¨ç½² K8S é›†ç¾¤"
log_info "èŠ‚ç‚¹ k8sc1 å®‰è£…å®Œæˆ" "k8sc1"
```

### 4.4 log_warn()

è®°å½•è­¦å‘Šçº§åˆ«æ—¥å¿—ã€‚

**å…¥å‚**:
- `$1` (string): æ—¥å¿—æ¶ˆæ¯
- `$2` (string, å¯é€‰): èŠ‚ç‚¹åç§°

**å‡ºå‚**: æ— 

**ç¤ºä¾‹**:
```bash
log_warn "å†…å­˜ä¸è¶³ï¼Œå¯èƒ½å½±å“æ€§èƒ½" "k8sw1"
```

### 4.5 log_error()

è®°å½•é”™è¯¯çº§åˆ«æ—¥å¿—ã€‚

**å…¥å‚**:
- `$1` (string): æ—¥å¿—æ¶ˆæ¯
- `$2` (string, å¯é€‰): èŠ‚ç‚¹åç§°

**å‡ºå‚**: æ— 

**ç¤ºä¾‹**:
```bash
log_error "SSH è¿æ¥å¤±è´¥" "k8sc1"
```

### 4.6 log_critical()

è®°å½•ä¸¥é‡é”™è¯¯çº§åˆ«æ—¥å¿—ã€‚

**å…¥å‚**:
- `$1` (string): æ—¥å¿—æ¶ˆæ¯
- `$2` (string, å¯é€‰): èŠ‚ç‚¹åç§°

**å‡ºå‚**: æ— 

**ç¤ºä¾‹**:
```bash
log_critical "é…ç½®æ–‡ä»¶æŸåï¼Œæ— æ³•ç»§ç»­"
```

### 4.7 log_success()

è®°å½•æˆåŠŸä¿¡æ¯ï¼ˆå¿«æ·æ–¹æ³•ï¼‰ã€‚

**å…¥å‚**:
- `$1` (string): æˆåŠŸæ¶ˆæ¯

**å‡ºå‚**: æ— 

**ç¤ºä¾‹**:
```bash
log_success "K8S é›†ç¾¤éƒ¨ç½²æˆåŠŸ"
```

### 4.8 log_failure()

è®°å½•å¤±è´¥ä¿¡æ¯ï¼ˆå¿«æ·æ–¹æ³•ï¼‰ã€‚

**å…¥å‚**:
- `$1` (string): å¤±è´¥æ¶ˆæ¯

**å‡ºå‚**: æ— 

**ç¤ºä¾‹**:
```bash
log_failure "Containerd å®‰è£…å¤±è´¥"
```

### 4.9 log_node_info()

è®°å½•èŠ‚ç‚¹ç›¸å…³ä¿¡æ¯ã€‚

**å…¥å‚**:
- `$1` (string): èŠ‚ç‚¹åç§°
- `$2` (string): æ—¥å¿—æ¶ˆæ¯

**å‡ºå‚**: æ— 

**ç¤ºä¾‹**:
```bash
log_node_info "k8sc1" "å¼€å§‹å®‰è£… Containerd"
```

---

## 5. éªŒè¯æ£€æŸ¥æ–¹æ³•

**æ–‡ä»¶ä½ç½®**: `utils/validator.sh`

### 5.1 validate_config()

éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼å’Œå¿…éœ€å‚æ•°ã€‚

**å…¥å‚**: æ— 

**å‡ºå‚**:
- è¿”å›å€¼: `0` éªŒè¯é€šè¿‡, `1` éªŒè¯å¤±è´¥

**éªŒè¯é¡¹**:
- é…ç½®æ–‡ä»¶å­˜åœ¨
- YAML è¯­æ³•æ­£ç¡®
- å¿…éœ€å‚æ•°éƒ½å·²é…ç½®
- å‚æ•°å€¼ç±»å‹æ­£ç¡®

**ç¤ºä¾‹**:
```bash
if ! validate_config; then
    log_error "é…ç½®éªŒè¯å¤±è´¥"
    exit 1
fi
```

### 5.2 validate_ip()

éªŒè¯ IP åœ°å€æ ¼å¼ã€‚

**å…¥å‚**:
- `$1` (string): IP åœ°å€

**å‡ºå‚**:
- è¿”å›å€¼: `0` æœ‰æ•ˆ, `1` æ— æ•ˆ

**ç¤ºä¾‹**:
```bash
if validate_ip "10.3.66.18"; then
    log_info "IP åœ°å€æœ‰æ•ˆ"
fi
```

### 5.3 validate_hostname()

éªŒè¯ä¸»æœºåæ ¼å¼ã€‚

**å…¥å‚**:
- `$1` (string): ä¸»æœºå

**å‡ºå‚**:
- è¿”å›å€¼: `0` æœ‰æ•ˆ, `1` æ— æ•ˆ

**éªŒè¯è§„åˆ™**:
- åªåŒ…å«å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦
- ä¸ä»¥è¿å­—ç¬¦å¼€å¤´æˆ–ç»“å°¾
- é•¿åº¦ 1-63 å­—ç¬¦

**ç¤ºä¾‹**:
```bash
if validate_hostname "k8sc1"; then
    log_info "ä¸»æœºåæœ‰æ•ˆ"
fi
```

### 5.4 validate_port()

éªŒè¯ç«¯å£å·æœ‰æ•ˆæ€§ã€‚

**å…¥å‚**:
- `$1` (int): ç«¯å£å·

**å‡ºå‚**:
- è¿”å›å€¼: `0` æœ‰æ•ˆ, `1` æ— æ•ˆ

**éªŒè¯è§„åˆ™**: 1-65535

**ç¤ºä¾‹**:
```bash
if validate_port 6443; then
    log_info "ç«¯å£å·æœ‰æ•ˆ"
fi
```

### 5.5 validate_os()

éªŒè¯æ“ä½œç³»ç»Ÿå…¼å®¹æ€§ã€‚

**å…¥å‚**:
- `$1` (string): èŠ‚ç‚¹ IP åœ°å€

**å‡ºå‚**:
- è¿”å›å€¼: `0` å…¼å®¹, `1` ä¸å…¼å®¹

**ç¤ºä¾‹**:
```bash
if ! validate_os "10.3.66.18"; then
    log_error "æ“ä½œç³»ç»Ÿä¸å…¼å®¹"
fi
```

### 5.6 validate_memory()

éªŒè¯å†…å­˜èµ„æºæ˜¯å¦æ»¡è¶³è¦æ±‚ã€‚

**å…¥å‚**:
- `$1` (string): èŠ‚ç‚¹ IP åœ°å€
- `$2` (int): è¦æ±‚çš„æœ€å°å†…å­˜ï¼ˆMBï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` æ»¡è¶³, `1` ä¸æ»¡è¶³

**ç¤ºä¾‹**:
```bash
if ! validate_memory "10.3.66.18" 4096; then
    log_error "å†…å­˜ä¸è¶³ï¼Œè‡³å°‘éœ€è¦ 4GB"
fi
```

### 5.7 validate_disk()

éªŒè¯ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³ã€‚

**å…¥å‚**:
- `$1` (string): èŠ‚ç‚¹ IP åœ°å€
- `$2` (string): æ£€æŸ¥è·¯å¾„
- `$3` (int): è¦æ±‚çš„æœ€å°ç©ºé—´ï¼ˆGBï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` å……è¶³, `1` ä¸å……è¶³

**ç¤ºä¾‹**:
```bash
if ! validate_disk "10.3.66.18" "/var/lib/containerd" 50; then
    log_error "ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œè‡³å°‘éœ€è¦ 50GB"
fi
```

### 5.8 validate_network()

éªŒè¯ç½‘ç»œè¿é€šæ€§ã€‚

**å…¥å‚**:
- `$1` (string): èŠ‚ç‚¹ IP åœ°å€
- `$2` (string, å¯é€‰): ç›®æ ‡åœ°å€ï¼ˆé»˜è®¤ä¸ºç½‘å…³ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` è¿é€š, `1` ä¸è¿é€š

**ç¤ºä¾‹**:
```bash
if validate_network "10.3.66.18"; then
    log_info "ç½‘ç»œè¿é€šæ­£å¸¸"
fi
```

### 5.9 validate_command()

éªŒè¯å‘½ä»¤æ˜¯å¦å­˜åœ¨ã€‚

**å…¥å‚**:
- `$1` (string): èŠ‚ç‚¹ IP åœ°å€
- `$2` (string): å‘½ä»¤åç§°

**å‡ºå‚**:
- è¿”å›å€¼: `0` å­˜åœ¨, `1` ä¸å­˜åœ¨

**ç¤ºä¾‹**:
```bash
if ! validate_command "10.3.66.18" "kubectl"; then
    log_error "kubectl æœªå®‰è£…"
fi
```

### 5.10 validate_service()

éªŒè¯æœåŠ¡çŠ¶æ€ã€‚

**å…¥å‚**:
- `$1` (string): èŠ‚ç‚¹ IP åœ°å€
- `$2` (string): æœåŠ¡åç§°

**å‡ºå‚**:
- è¿”å›å€¼: `0` è¿è¡Œä¸­, `1` æœªè¿è¡Œ

**ç¤ºä¾‹**:
```bash
if validate_service "10.3.66.18" "containerd"; then
    log_info "Containerd æœåŠ¡è¿è¡Œæ­£å¸¸"
fi
```

---

## 6. é‡è¯•æœºåˆ¶æ–¹æ³•

**æ–‡ä»¶ä½ç½®**: `utils/retry.sh`

### 6.1 retry_execute()

é‡è¯•æ‰§è¡Œå‘½ä»¤ç›´åˆ°æˆåŠŸæˆ–è¾¾åˆ°æœ€å¤§æ¬¡æ•°ã€‚

**å…¥å‚**:
- `$1` (string): èŠ‚ç‚¹ IP åœ°å€
- `$2` (string): è¦æ‰§è¡Œçš„å‘½ä»¤
- `$3` (int, å¯é€‰): æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ 3ï¼‰
- `$4` (int, å¯é€‰): é‡è¯•é—´éš”ï¼ˆç§’ï¼Œé»˜è®¤ 5ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥

**é‡è¯•ç­–ç•¥**:
- å›ºå®šé—´éš”é‡è¯•

**ç¤ºä¾‹**:
```bash
retry_execute "10.3.66.18" "yum install -y containerd" 3 10
```

### 6.2 retry_function()

é‡è¯•æ‰§è¡Œå‡½æ•°ã€‚

**å…¥å‚**:
- `$1` (string): å‡½æ•°åç§°
- `$2` (int, å¯é€‰): æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ 3ï¼‰
- `$3` (int, å¯é€‰): é‡è¯•é—´éš”ï¼ˆç§’ï¼Œé»˜è®¤ 5ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥

**ç¤ºä¾‹**:
```bash
retry_execute "install_containerd" 5 10
```

### 6.3 wait_for_condition()

ç­‰å¾…æ¡ä»¶æ»¡è¶³ã€‚

**å…¥å‚**:
- `$1` (string): æ¡ä»¶å‘½ä»¤ï¼ˆè¿”å› 0 è¡¨ç¤ºæ»¡è¶³ï¼‰
- `$2` (int): è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
- `$3` (int, å¯é€‰): æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼Œé»˜è®¤ 2ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` æ¡ä»¶æ»¡è¶³, `1` è¶…æ—¶

**ç¤ºä¾‹**:
```bash
wait_for_condition "ssh test@10.3.66.18 'test -f /tmp/ready'" 60
```

### 6.4 wait_for_port()

ç­‰å¾…ç«¯å£å¯ç”¨ã€‚

**å…¥å‚**:
- `$1` (string): èŠ‚ç‚¹ IP åœ°å€
- `$2` (int): ç«¯å£å·
- `$3` (int, å¯é€‰): è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤ 60ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` ç«¯å£å¯ç”¨, `1` è¶…æ—¶

**ç¤ºä¾‹**:
```bash
wait_for_port "10.3.66.18" 6443 120
```

### 6.5 wait_for_service_ready()

ç­‰å¾…æœåŠ¡å°±ç»ªã€‚

**å…¥å‚**:
- `$1` (string): èŠ‚ç‚¹ IP åœ°å€
- `$2` (string): æœåŠ¡åç§°
- `$3` (int, å¯é€‰): è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤ 120ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` æœåŠ¡å°±ç»ª, `1` è¶…æ—¶

**ç¤ºä¾‹**:
```bash
wait_for_service_ready "10.3.66.18" "apiserver" 180
```

### 6.6 wait_for_pod_ready()

ç­‰å¾… Pod å°±ç»ªã€‚

**å…¥å‚**:
- `$1` (string): æ§åˆ¶èŠ‚ç‚¹ IP åœ°å€
- `$2` (string): Pod åç§°
- `$3` (string): å‘½åç©ºé—´
- `$4` (int, å¯é€‰): è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤ 300ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` Pod å°±ç»ª, `1` è¶…æ—¶

**ç¤ºä¾‹**:
```bash
wait_for_pod_ready "10.3.66.18" "coredns-xxx" "kube-system" 300
```

---

## 7. æ¨¡å—ç®¡ç†æ–¹æ³•

**æ–‡ä»¶ä½ç½®**: `core/module_manager.sh`

### 7.1 module_load()

åŠ è½½æŒ‡å®šæ¨¡å—ã€‚

**å…¥å‚**:
- `$1` (string): æ¨¡å—è„šæœ¬è·¯å¾„

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥

**ç¤ºä¾‹**:
```bash
module_load "modules/02-k8s-cluster/k8s_install.sh"
```

### 7.2 module_execute()

æ‰§è¡Œæ¨¡å—ï¼ˆå®Œæ•´æµç¨‹ï¼‰ã€‚

**å…¥å‚**:
- `$1` (string): æ¨¡å—è„šæœ¬è·¯å¾„
- `$2` (string): æ¨¡å—åç§°

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥

**æ‰§è¡Œæµç¨‹**:
1. åŠ è½½æ¨¡å—
2. æ‰§è¡Œ `module_pre_check()`
3. æ‰§è¡Œ `module_install()`
4. æ‰§è¡Œ `module_post_check()`
5. ä»»ä½•æ­¥éª¤å¤±è´¥åˆ™æ‰§è¡Œ `module_rollback()`

**ç¤ºä¾‹**:
```bash
module_execute "modules/02-k8s-cluster/k8s_install.sh" "K8S ç»„ä»¶å®‰è£…"
```

### 7.3 module_pre_check()

æ‰§è¡Œæ¨¡å—å‰ç½®æ£€æŸ¥ã€‚

**å…¥å‚**: æ— ï¼ˆè°ƒç”¨å½“å‰åŠ è½½æ¨¡å—çš„å‡½æ•°ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` é€šè¿‡, `1` å¤±è´¥

**ç¤ºä¾‹**:
```bash
source modules/02-k8s-cluster/k8s_install.sh
module_pre_check
```

### 7.4 module_install()

æ‰§è¡Œæ¨¡å—å®‰è£…ã€‚

**å…¥å‚**: æ— ï¼ˆè°ƒç”¨å½“å‰åŠ è½½æ¨¡å—çš„å‡½æ•°ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥

**ç¤ºä¾‹**:
```bash
source modules/02-k8s-cluster/k8s_install.sh
module_install
```

### 7.5 module_post_check()

æ‰§è¡Œæ¨¡å—åç½®éªŒè¯ã€‚

**å…¥å‚**: æ— ï¼ˆè°ƒç”¨å½“å‰åŠ è½½æ¨¡å—çš„å‡½æ•°ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` é€šè¿‡, `1` å¤±è´¥

**ç¤ºä¾‹**:
```bash
source modules/02-k8s-cluster/k8s_install.sh
module_post_check
```

### 7.6 module_rollback()

æ‰§è¡Œæ¨¡å—å›æ»šã€‚

**å…¥å‚**: æ— ï¼ˆè°ƒç”¨å½“å‰åŠ è½½æ¨¡å—çš„å‡½æ•°ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥

**ç¤ºä¾‹**:
```bash
source modules/02-k8s-cluster/k8s_install.sh
module_rollback
```

### 7.7 module_info()

è·å–æ¨¡å—ä¿¡æ¯ã€‚

**å…¥å‚**: æ— ï¼ˆè°ƒç”¨å½“å‰åŠ è½½æ¨¡å—çš„å‡½æ•°ï¼‰

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: æ¨¡å—ä¿¡æ¯ï¼ˆåç§°ã€ç‰ˆæœ¬ã€é˜¶æ®µï¼‰

**ç¤ºä¾‹**:
```bash
source modules/02-k8s-cluster/k8s_install.sh
module_info
# è¾“å‡º:
# æ¨¡å—: K8S ç»„ä»¶å®‰è£…
# ç‰ˆæœ¬: 1.0.0
# é˜¶æ®µ: 02-k8s-cluster
```

### 7.8 module_list()

åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ¨¡å—ã€‚

**å…¥å‚**: æ— 

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: æ¨¡å—åˆ—è¡¨

**ç¤ºä¾‹**:
```bash
module_list
# è¾“å‡º:
# modules/00-base-env/yum_config.sh
# modules/00-base-env/network_config.sh
# modules/01-containerd/containerd_install.sh
# ...
```

---

## 8. çŠ¶æ€ç®¡ç†æ–¹æ³•

**æ–‡ä»¶ä½ç½®**: `core/state_manager.sh`

### 8.1 state_create()

åˆ›å»ºéƒ¨ç½²çŠ¶æ€æ–‡ä»¶ã€‚

**å…¥å‚**: æ— 

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥

**åˆå§‹åŒ–çŠ¶æ€**:
```json
{
    "deployment_id": "20260118_100000",
    "start_time": "2026-01-18T10:00:00Z",
    "status": "running",
    "current_stage": "00-base-env",
    "completed_stages": [],
    "failed_stages": []
}
```

### 8.2 state_load()

åŠ è½½éƒ¨ç½²çŠ¶æ€ã€‚

**å…¥å‚**: æ— 

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥ï¼ˆçŠ¶æ€æ–‡ä»¶ä¸å­˜åœ¨ï¼‰

### 8.3 state_save()

ä¿å­˜éƒ¨ç½²çŠ¶æ€ã€‚

**å…¥å‚**: æ— ï¼ˆä¿å­˜å…¨å±€çŠ¶æ€å˜é‡ï¼‰

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥

### 8.4 state_update()

æ›´æ–°çŠ¶æ€å€¼ã€‚

**å…¥å‚**:
- `$1` (string): çŠ¶æ€é”®
- `$2` (string): çŠ¶æ€å€¼

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥

**ç¤ºä¾‹**:
```bash
state_update "status" "completed"
state_update "current_stage" "02-k8s-cluster"
```

### 8.5 state_get()

è·å–çŠ¶æ€å€¼ã€‚

**å…¥å‚**:
- `$1` (string): çŠ¶æ€é”®

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: çŠ¶æ€å€¼

**ç¤ºä¾‹**:
```bash
status=$(state_get "status")
current_stage=$(state_get "current_stage")
```

### 8.6 state_is_completed()

æ£€æŸ¥é˜¶æ®µæ˜¯å¦å·²å®Œæˆã€‚

**å…¥å‚**:
- `$1` (string): é˜¶æ®µæ ‡è¯†

**å‡ºå‚**:
- è¿”å›å€¼: `0` å·²å®Œæˆ, `1` æœªå®Œæˆ

**ç¤ºä¾‹**:
```bash
if state_is_completed "00-base-env"; then
    log_info "åŸºç¡€ç¯å¢ƒå‡†å¤‡å·²å®Œæˆï¼Œè·³è¿‡"
fi
```

### 8.7 state_get_current_stage()

è·å–å½“å‰æ‰§è¡Œé˜¶æ®µã€‚

**å…¥å‚**: æ— 

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: å½“å‰é˜¶æ®µæ ‡è¯†

**ç¤ºä¾‹**:
```bash
current_stage=$(state_get_current_stage)
```

### 8.8 state_set_stage_completed()

æ ‡è®°é˜¶æ®µä¸ºå·²å®Œæˆã€‚

**å…¥å‚**:
- `$1` (string): é˜¶æ®µæ ‡è¯†

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥

**ç¤ºä¾‹**:
```bash
state_set_stage_completed "00-base-env"
```

### 8.9 state_reset()

é‡ç½®éƒ¨ç½²çŠ¶æ€ã€‚

**å…¥å‚**: æ— 

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ

**ç¤ºä¾‹**:
```bash
state_reset
```

---

## 9. é€šç”¨å·¥å…·æ–¹æ³•

**æ–‡ä»¶ä½ç½®**: `utils/common.sh`

### 9.1 trim()

å»é™¤å­—ç¬¦ä¸²é¦–å°¾ç©ºæ ¼ã€‚

**å…¥å‚**:
- `$1` (string): è¾“å…¥å­—ç¬¦ä¸²

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: å¤„ç†åçš„å­—ç¬¦ä¸²

**ç¤ºä¾‹**:
```bash
result=$(trim "  hello world  ")
# è¾“å‡º: "hello world"
```

### 9.2 to_lower()

è½¬æ¢ä¸ºå°å†™ã€‚

**å…¥å‚**:
- `$1` (string): è¾“å…¥å­—ç¬¦ä¸²

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: å°å†™å­—ç¬¦ä¸²

**ç¤ºä¾‹**:
```bash
result=$(to_lower "Hello World")
# è¾“å‡º: "hello world"
```

### 9.3 to_upper()

è½¬æ¢ä¸ºå¤§å†™ã€‚

**å…¥å‚**:
- `$1` (string): è¾“å…¥å­—ç¬¦ä¸²

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: å¤§å†™å­—ç¬¦ä¸²

**ç¤ºä¾‹**:
```bash
result=$(to_upper "Hello World")
# è¾“å‡º: "HELLO WORLD"
```

### 9.4 file_exists()

æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚

**å…¥å‚**:
- `$1` (string): æ–‡ä»¶è·¯å¾„

**å‡ºå‚**:
- è¿”å›å€¼: `0` å­˜åœ¨, `1` ä¸å­˜åœ¨

**ç¤ºä¾‹**:
```bash
if file_exists "/tmp/config.yaml"; then
    log_info "é…ç½®æ–‡ä»¶å­˜åœ¨"
fi
```

### 9.5 dir_exists()

æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨ã€‚

**å…¥å‚**:
- `$1` (string): ç›®å½•è·¯å¾„

**å‡ºå‚**:
- è¿”å›å€¼: `0` å­˜åœ¨, `1` ä¸å­˜åœ¨

**ç¤ºä¾‹**:
```bash
if ! dir_exists "/data/kubelet_root"; then
    create_dir "/data/kubelet_root"
fi
```

### 9.6 create_dir()

åˆ›å»ºç›®å½•ã€‚

**å…¥å‚**:
- `$1` (string): ç›®å½•è·¯å¾„

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥

**ç¤ºä¾‹**:
```bash
create_dir "/data/kubelet_root"
```

### 9.7 remove_file()

åˆ é™¤æ–‡ä»¶ã€‚

**å…¥å‚**:
- `$1` (string): æ–‡ä»¶è·¯å¾„

**å‡ºå‚**:
- è¿”å›å€¼: `0` æˆåŠŸ, `1` å¤±è´¥

**ç¤ºä¾‹**:
```bash
remove_file "/tmp/temp.yaml"
```

### 9.8 confirm()

ç”¨æˆ·ç¡®è®¤æç¤ºã€‚

**å…¥å‚**:
- `$1` (string): æç¤ºä¿¡æ¯

**å‡ºå‚**:
- è¿”å›å€¼: `0` ç”¨æˆ·ç¡®è®¤, `1` ç”¨æˆ·å–æ¶ˆ

**ç¤ºä¾‹**:
```bash
if confirm "æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ"; then
    log_info "ç”¨æˆ·ç¡®è®¤ç»§ç»­"
fi
```

### 9.9 select_option()

ç”¨æˆ·é€‰æ‹©æç¤ºã€‚

**å…¥å‚**:
- `$1` (string): æç¤ºä¿¡æ¯
- `$2` (string): é€‰é¡¹åˆ—è¡¨ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: ç”¨æˆ·é€‰æ‹©çš„é€‰é¡¹

**ç¤ºä¾‹**:
```bash
choice=$(select_option "è¯·é€‰æ‹©ç½‘ç»œæ’ä»¶" "flannel calico canal")
```

### 9.10 get_timestamp()

è·å–å½“å‰æ—¶é—´æˆ³ã€‚

**å…¥å‚**: æ— 

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: æ—¶é—´æˆ³ï¼ˆå¦‚ï¼š`20260118100000`ï¼‰

**ç¤ºä¾‹**:
```bash
timestamp=$(get_timestamp)
```

### 9.11 format_datetime()

æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ã€‚

**å…¥å‚**:
- `$1` (string): æ—¥æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼Œé»˜è®¤å½“å‰æ—¶é—´ï¼‰

**å‡ºå‚**:
- æ ‡å‡†è¾“å‡º: æ ¼å¼åŒ–çš„æ—¥æœŸæ—¶é—´ï¼ˆå¦‚ï¼š`2026-01-18 10:00:00`ï¼‰

**ç¤ºä¾‹**:
```bash
datetime=$(format_datetime)
```

---

## 10. éƒ¨ç½²æµç¨‹è°ƒç”¨ç¤ºä¾‹

### 10.1 åŸºç¡€ç¯å¢ƒå‡†å¤‡

```bash
# åŠ è½½é…ç½®
config_load "config/config.yaml"

# è·å–æ‰€æœ‰èŠ‚ç‚¹
all_nodes=$(config_get_all_nodes)

# åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œ
for node in $all_nodes; do
    node_ip=$(config_get_node "$node" "ip")

    log_info "åœ¨èŠ‚ç‚¹ $node ($node_ip) ä¸Šé…ç½® YUM æº"

    # é€šè¿‡ SSH åœ¨è¿œç¨‹èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤
    ssh_execute "$node_ip" "
        mkdir -p /var/www/html/repo
        # ... YUM é…ç½®å‘½ä»¤
    "

    if [ $? -eq 0 ]; then
        log_success "èŠ‚ç‚¹ $node YUM æºé…ç½®æˆåŠŸ"
    else
        log_error "èŠ‚ç‚¹ $node YUM æºé…ç½®å¤±è´¥"
        exit 1
    fi
done
```

### 10.2 K8S ç»„ä»¶å®‰è£…

```bash
# è·å–æ‰€æœ‰èŠ‚ç‚¹
all_nodes=$(config_get_all_nodes)
k8s_version=$(config_get ".k8s.version")

# åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå®‰è£… K8S ç»„ä»¶
for node in $all_nodes; do
    node_ip=$(config_get_node "$node" "ip")

    log_info "åœ¨èŠ‚ç‚¹ $node ä¸Šå®‰è£… K8S ç»„ä»¶..."

    # é‡è¯•æ‰§è¡Œå®‰è£…å‘½ä»¤
    retry_execute "$node_ip" "
        yum install -y kubelet-$k8s_version kubeadm-$k8s_version
        systemctl enable kubelet
    " 3 10

    if [ $? -eq 0 ]; then
        log_success "èŠ‚ç‚¹ $node K8S ç»„ä»¶å®‰è£…æˆåŠŸ"
    else
        log_error "èŠ‚ç‚¹ $node K8S ç»„ä»¶å®‰è£…å¤±è´¥"
        exit 1
    fi
done
```

### 10.3 æ§åˆ¶å¹³é¢åˆå§‹åŒ–

```bash
# è·å–ä¸»æ§åˆ¶èŠ‚ç‚¹
master_node=$(config_get_control_nodes | head -1)
master_ip=$(config_get_node "$master_node" "ip")

log_info "åœ¨ä¸»æ§åˆ¶èŠ‚ç‚¹ $master_node ($master_ip) ä¸Šåˆå§‹åŒ–é›†ç¾¤..."

# æ£€æŸ¥å‰ç½®æ¡ä»¶
if ! validate_service "$master_ip" "containerd"; then
    log_error "Containerd æœªè¿è¡Œ"
    exit 1
fi

# æ‰§è¡Œåˆå§‹åŒ–å‘½ä»¤
ssh_execute "$master_ip" "
    kubeadm init --config=/tmp/kubeadm-config.yaml --upload-certs
"

if [ $? -ne 0 ]; then
    log_error "é›†ç¾¤åˆå§‹åŒ–å¤±è´¥"
    exit 1
fi

# è·å– join å‘½ä»¤
join_cmd=$(ssh_execute "$master_ip" "kubeadm token create --print-join-command")
log_info "Join å‘½ä»¤: $join_cmd"

# ä¿å­˜ join ä¿¡æ¯åˆ°ä¸´æ—¶æ–‡ä»¶
cat > /tmp/k8s_join_info.sh <<EOF
JOIN_TOKEN_CMD="$join_cmd"
EOF
```

### 10.4 èŠ‚ç‚¹åŠ å…¥é›†ç¾¤

```bash
# åŠ è½½ join ä¿¡æ¯
source /tmp/k8s_join_info.sh

# æ·»åŠ å…¶ä»–æ§åˆ¶èŠ‚ç‚¹
control_nodes=$(config_get_control_nodes | tail -n +2)
for node in $control_nodes; do
    node_ip=$(config_get_node "$node" "ip")

    log_info "æ§åˆ¶èŠ‚ç‚¹ $node åŠ å…¥é›†ç¾¤..."

    ssh_execute "$node_ip" "
        $JOIN_TOKEN_CMD --control-plane --certificate-key <cert-key>
    "

    if [ $? -eq 0 ]; then
        log_success "æ§åˆ¶èŠ‚ç‚¹ $node åŠ å…¥æˆåŠŸ"
    else
        log_error "æ§åˆ¶èŠ‚ç‚¹ $node åŠ å…¥å¤±è´¥"
    fi
done

# æ·»åŠ å·¥ä½œèŠ‚ç‚¹
worker_nodes=$(config_get_worker_nodes)
for node in $worker_nodes; do
    node_ip=$(config_get_node "$node" "ip")

    log_info "å·¥ä½œèŠ‚ç‚¹ $node åŠ å…¥é›†ç¾¤..."

    ssh_execute "$node_ip" "$JOIN_TOKEN_CMD"

    if [ $? -eq 0 ]; then
        log_success "å·¥ä½œèŠ‚ç‚¹ $node åŠ å…¥æˆåŠŸ"
    else
        log_error "å·¥ä½œèŠ‚ç‚¹ $node åŠ å…¥å¤±è´¥"
    fi
done
```

### 10.5 éƒ¨ç½²æ–‡ä»¶åˆ†å‘

```bash
# åŠ è½½é…ç½®
config_load "config/config.yaml"

# è·å–æ‰€æœ‰èŠ‚ç‚¹
all_nodes=$(config_get_all_nodes)

# åˆ†å‘å®‰è£…æ–‡ä»¶åˆ°æ‰€æœ‰èŠ‚ç‚¹
for node in $all_nodes; do
    node_ip=$(config_get_node "$node" "ip")

    log_info "åˆ†å‘å®‰è£…æ–‡ä»¶åˆ°èŠ‚ç‚¹ $node ($node_ip)..."

    # å¤åˆ¶æ•´ä¸ª k8s_install ç›®å½•ï¼ˆæ’é™¤æ—¥å¿—æ–‡ä»¶ï¼‰
    ssh_copy_directory "/data/k8s_install" "$node_ip" "/data/k8s_install" "*.log"

    if [ $? -eq 0 ]; then
        log_success "èŠ‚ç‚¹ $node å®‰è£…æ–‡ä»¶åˆ†å‘æˆåŠŸ"
    else
        log_error "èŠ‚ç‚¹ $node å®‰è£…æ–‡ä»¶åˆ†å‘å¤±è´¥"
        exit 1
    fi
done

# åˆ†å‘é…ç½®æ–‡ä»¶åˆ°æ§åˆ¶èŠ‚ç‚¹
control_nodes=$(config_get_control_nodes)
for node in $control_nodes; do
    node_ip=$(config_get_node "$node" "ip")

    log_info "åˆ†å‘é…ç½®æ–‡ä»¶åˆ°æ§åˆ¶èŠ‚ç‚¹ $node..."

    # å¤åˆ¶é…ç½®æ–‡ä»¶
    ssh_copy_file "/tmp/kubeadm-config.yaml" "$node_ip" "/tmp/"

    # å¤åˆ¶è¯ä¹¦ç›®å½•
    ssh_copy_directory "/etc/kubernetes/pki" "$node_ip" "/etc/kubernetes/pki"
done

# åˆ†å‘è„šæœ¬æ–‡ä»¶åˆ°å·¥ä½œèŠ‚ç‚¹ï¼ˆæ’é™¤ä¸´æ—¶æ–‡ä»¶ï¼‰
worker_nodes=$(config_get_worker_nodes)
for node in $worker_nodes; do
    node_ip=$(config_get_node "$node" "ip")

    log_info "åˆ†å‘è„šæœ¬åˆ°å·¥ä½œèŠ‚ç‚¹ $node..."

    # æ’é™¤ .tmp å’Œ .bak æ–‡ä»¶
    ssh_copy_directory "/data/scripts" "$node_ip" "/data/scripts" "*.tmp --exclude=*.bak"

    if [ $? -eq 0 ]; then
        log_success "èŠ‚ç‚¹ $node è„šæœ¬åˆ†å‘æˆåŠŸ"
    else
        log_warn "èŠ‚ç‚¹ $node è„šæœ¬åˆ†å‘å¤±è´¥ï¼Œå°†ç»§ç»­"
    fi
done
```

---

## 11. æ€»ç»“

### æ ¸å¿ƒæœºåˆ¶

1. **ä¸­å¤®æ§åˆ¶** - deploy.sh åœ¨æœ¬åœ°è¿è¡Œï¼Œé€šè¿‡å…¬ç”¨æ–¹æ³•æ§åˆ¶éƒ¨ç½²
2. **SSH è¿œç¨‹æ‰§è¡Œ** - æ‰€æœ‰æ“ä½œé€šè¿‡ `ssh_execute()` åœ¨è¿œç¨‹èŠ‚ç‚¹æ‰§è¡Œ
3. **é…ç½®é©±åŠ¨** - YAML é…ç½®æ–‡ä»¶é€šè¿‡ `config_get()` ç³»åˆ—æ–¹æ³•è§£æ
4. **æ¨¡å—åŒ–è®¾è®¡** - æ¯ä¸ªåŠŸèƒ½é€šè¿‡ `module_execute()` æ‰§è¡Œ
5. **çŠ¶æ€è¿½è¸ª** - é€šè¿‡ `state_*()` ç³»åˆ—æ–¹æ³•è®°å½•éƒ¨ç½²è¿›åº¦

### å…³é”®æ–¹æ³•

| æ–¹æ³• | ä½œç”¨ |
|------|------|
| `config_get_node()` | è·å–èŠ‚ç‚¹ IPï¼Œç¡®ä¿åœ¨æ­£ç¡®çš„æœºå™¨ä¸Šæ‰§è¡Œ |
| `ssh_execute()` | åœ¨è¿œç¨‹èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤ |
| `ssh_copy_directory()` | å¤åˆ¶æ–‡ä»¶å¤¹åˆ°è¿œç¨‹èŠ‚ç‚¹ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼  |
| `log_info()` | è®°å½•æ‰§è¡Œæ—¥å¿— |
| `retry_execute()` | å¤±è´¥é‡è¯•ï¼Œæé«˜æˆåŠŸç‡ |
| `module_execute()` | æ‰§è¡Œéƒ¨ç½²æ¨¡å— |

### æ‰§è¡Œæµç¨‹

```
deploy.sh
  â†“
config_load() - åŠ è½½é…ç½®
  â†“
for node in $(config_get_all_nodes()) - å¾ªç¯èŠ‚ç‚¹
  â†“
node_ip = config_get_node(node, "ip") - è·å–IP
  â†“
ssh_execute(node_ip, command) - è¿œç¨‹æ‰§è¡Œ
  â†“
æ£€æŸ¥è¿”å›å€¼ - åˆ¤æ–­æˆåŠŸ/å¤±è´¥
  â†“
log_info() - è®°å½•æ—¥å¿—
  â†“
ç»§ç»­ä¸‹ä¸€æ­¥æˆ–å›æ»š
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 3.0.0
**æœ€åæ›´æ–°**: 2026-01-18
**ä½œè€…**: KubeFoundry Team
